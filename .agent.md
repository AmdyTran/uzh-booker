# UZH Booking System - Developer Guide

## Project Overview

- **Purpose**: High-performance async booking system for University of Zurich (UZH) resource reservations
- **Language**: Python 3.12+
- **Architecture**: Async/await with concurrent "spam booking" strategy
- **Key Strategy**: Concurrent requests to maximize success in competitive booking scenarios
- **Framework**: httpx for async HTTP, Pydantic for configuration, VCR.py for testing

## Key Files and Directories

### Core Application
- `scheduler/amain.py` - **Main refactored async booking module** (recommended)
- `scheduler/main.py` - Legacy synchronous booking implementation
- `scheduler/config.py` - Configuration classes and constants
- `scheduler/.env` - Environment variables (credentials, not in git)
- `scheduler/.env.example` - Template for environment setup

### Testing
- `tests/test_amain.py` - Comprehensive test suite using VCR
- `tests/cassettes/` - Recorded HTTP interactions for testing
- `pytest.ini` - Test configuration with async support

### Utilities
- `demo_refactored.py` - Interactive demo of the booking system
- `record_cassettes.py` - Helper script to record VCR cassettes
- `README.md` - Comprehensive user documentation

### Configuration
- `pyproject.toml` - Project dependencies and scripts
- `uv.lock` - Dependency lock file (uv package manager)

## Development Workflow

### Setup
```bash
# Install dependencies
uv sync

# Set up environment
cp scheduler/.env.example scheduler/.env
# Edit .env with real UZH credentials
```

### Code Quality (ALWAYS RUN AFTER CHANGES)
```bash
# Format and lint (mandatory)
uv run ruff format .
uv run ruff check .

# Type checking
uv run mypy scheduler/

# Run tests
uv run pytest tests/ -v
```

### Available Scripts
```bash
# Booking commands
uv run book-async          # Main async booking (recommended)
uv run book                # Legacy sync booking
uv run refresh-async       # Refresh auth session

# Development utilities
uv run record-cassettes    # Record VCR test cassettes
uv run pytest             # Run test suite
```

## Architecture Patterns

### Data Classes
- Use `@dataclass` for structured data (BookingRequest, BookingResult)
- Type hints are mandatory for all function parameters and returns
- Follow the existing pattern for new data structures

### Async Patterns
- Use `async with authenticated_session()` for HTTP operations
- All booking operations should be concurrent using `asyncio.gather()`
- Context managers for resource cleanup (sessions, clients)

### Error Handling
- Custom exceptions: `SessionExpiredError`, `AuthenticationError`, `BookingError`
- Graceful degradation with retry logic
- Comprehensive logging with structured messages

### Configuration
- Environment variables in `scheduler/.env` (never commit)
- Constants in `scheduler/config.py` `BookingConstants` class
- Booking parameters in `BookingDetails` Pydantic model

## Testing Best Practices

### VCR Testing Strategy
- **Recording tests** (`-m live`): Record real HTTP interactions once
- **Replay tests** (default): Use recorded data for fast, consistent testing
- **Utility tests**: Pure functions without HTTP calls

### Test Commands
```bash
# Run all tests (uses recorded cassettes)
uv run pytest tests/ -v

# Record new cassettes (requires real credentials)
uv run pytest tests/ -m live -v

# Run only offline tests
uv run pytest tests/ -v -m "not live"
```

### Test Structure
- One test file per main module
- Group tests by functionality using classes
- Use descriptive test names explaining the scenario
- Mock external dependencies, use VCR for HTTP

## Spam Booking Strategy

### Core Concept
- **Concurrent execution**: All 32 resources attempted simultaneously
- **Speed optimization**: ~30x faster than sequential requests
- **Expected results**: 0-5% success rate is normal and expected
- **Error handling**: 95%+ failures are expected behavior

### Performance Characteristics
- 32 concurrent requests in ~3-5 seconds
- Average 0.1-0.2 seconds per request
- Success rate: 0-5% (1-2 bookings out of 32 attempts)
- Common error: "Es ist nur eine Reservierung zur selben Zeit m√∂glich"

### Implementation Guidelines
- Always use `asyncio.gather()` for concurrent requests
- Handle `SessionExpiredError` with automatic retry
- Log performance metrics (timing, success/failure counts)
- Expect and handle high failure rates gracefully

## Configuration Management

### Environment Variables
```bash
# Required in scheduler/.env
UZH_USERNAME="your.email@uzh.ch"
UZH_PASSWORD="your_password"
UZH_TOTP_SECRET="your_totp_secret"
```

### Booking Parameters
Edit `scheduler/config.py` `BookingDetails` class:
- `preferred_start_time_hour/minute` - Booking time slot
- `preferred_range_start/end` - Resource ID range (231-262)
- `owner_id` - Your UZH user ID
- `standard_attribute_values` - Department/group attributes

### Constants
Edit `scheduler/config.py` `BookingConstants` class:
- HTTP timeouts and headers
- Cache expiry settings
- Concurrency limits

## Code Style and Conventions

### Imports
- Use `from __future__ import annotations` for forward references
- Group imports: standard library, third-party, local
- Use absolute imports for scheduler modules

### Naming
- Functions: `snake_case`
- Classes: `PascalCase`
- Constants: `UPPER_SNAKE_CASE`
- Private methods: `_leading_underscore`

### Type Hints
- All function parameters and returns must be typed
- Use `| None` instead of `Optional`
- Use `list[Type]` instead of `List[Type]`
- Protocol classes for interface definitions

### Logging
- Use structured logging with emojis for readability
- Log performance metrics (timing, counts)
- Use appropriate log levels (INFO for normal flow, WARNING for expected failures)

### Error Handling
- Specific exception types for different failure modes
- Always log exceptions with context
- Graceful degradation where possible
- Retry logic for transient failures

## Security Considerations

### Credentials
- Never commit `.env` files or credentials
- Use environment variables for all sensitive data
- Filter sensitive data in VCR cassettes
- Rotate TOTP secrets regularly

### HTTP Security
- Use proper User-Agent headers to avoid blocking
- Implement rate limiting to respect server resources
- Handle CSRF tokens securely
- Filter sensitive headers in test recordings

## Performance Guidelines

### Concurrency
- Use `asyncio.gather()` for parallel HTTP requests
- Limit concurrent requests to avoid overwhelming servers
- Monitor response times and adjust concurrency accordingly

### Caching
- Cache authentication sessions (6-hour expiry)
- Store CSRF tokens with sessions
- Use persistent cache for session data
- Clear cache on authentication failures

### Monitoring
- Log timing for all operations
- Track success/failure rates
- Monitor session expiry patterns
- Alert on unusual error rates

## Troubleshooting

### Common Issues
- `SessionExpiredError`: Normal, automatic retry will handle
- `AuthenticationError`: Check credentials in `.env`
- No successful bookings: Expected behavior, try different times
- CSRF token errors: Clear cache or refresh session

### Debug Mode
```bash
# Enable debug logging
export PYTHONPATH=. && python -c "
import logging
logging.basicConfig(level=logging.DEBUG)
from scheduler.amain import main_async
import asyncio
asyncio.run(main_async())
"
```

### Cache Management
```bash
# Clear authentication cache
rm -rf scheduler/.cache/

# Refresh CSRF token
uv run refresh-async
```

## Contributing Guidelines

### Before Committing
1. Run code quality checks: `uv run ruff format . && uv run ruff check .`
2. Run test suite: `uv run pytest tests/ -v`
3. Update documentation if adding new features
4. Record new VCR cassettes if changing HTTP interactions

### Pull Request Process
1. Create feature branch from main
2. Implement changes with tests
3. Ensure all tests pass
4. Update README.md if needed
5. Submit PR with clear description

### Code Review Checklist
- [ ] All functions have type hints
- [ ] Error handling is comprehensive
- [ ] Tests cover new functionality
- [ ] Performance impact is considered
- [ ] Security implications are reviewed
- [ ] Documentation is updated

## Deployment Notes

### Production Considerations
- Use environment variables for all configuration
- Monitor success rates and performance
- Implement proper logging and alerting
- Respect UZH server resources
- Follow university booking policies

### Ethical Usage
- Don't overload UZH servers
- Use reasonable request frequencies
- Respect fair competition principles
- Comply with university policies
- Report issues to UZH IT if system problems occur